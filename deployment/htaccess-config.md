# WordPress .htaccess Configuration for Next.js Integration

This document details the required .htaccess configuration to properly integrate the Next.js application with the existing WordPress installation. The rules are designed to route requests with the "-next" suffix to the Next.js application while maintaining all other WordPress functionality.

## Complete .htaccess File

Below is the complete .htaccess file that should be placed in the WordPress root directory (`/var/www/html/mx/`):

```apache
# BEGIN WordPress with Next.js Integration
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /mx/

# Protect .htaccess, wp-config.php, and other sensitive files
<FilesMatch "^(\.htaccess|wp-config\.php|xmlrpc\.php|wp-admin/includes/.*\.php)">
    Order deny,allow
    Deny from all
</FilesMatch>

# Allow direct access to specific files that don't need to be processed by WordPress
<FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot)$">
    Order allow,deny
    Allow from all
</FilesMatch>

# Route -next suffix URLs to the Next.js application
# These are the URLs used in Google Ads for testing
RewriteRule ^recomendador-de-tarjetas-de-credito-p1-next(/.*)?$ topfinanzas-pages-mx/recomendador-de-tarjetas-de-credito-p1-next [L,QSA]
RewriteRule ^soluciones-financieras/([^/]+)-next(/.*)?$ topfinanzas-pages-mx/soluciones-financieras/$1-next [L,QSA]

# Handle static assets from Next.js
RewriteRule ^_next/(.*)$ topfinanzas-pages-mx/_next/$1 [L]

# Handle Next.js API routes
RewriteRule ^api/(.*)$ topfinanzas-pages-mx/api/$1 [L,QSA]

# Default WordPress handling for all other requests
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /mx/index.php [L]
</IfModule>
# END WordPress with Next.js Integration
```

## Rule Explanations

### Basic Setup

```apache
RewriteEngine On
RewriteBase /mx/
```

These lines enable the Apache rewrite engine and set the base directory to `/mx/`.

### File Protection

```apache
<FilesMatch "^(\.htaccess|wp-config\.php|xmlrpc\.php|wp-admin/includes/.*\.php)">
    Order deny,allow
    Deny from all
</FilesMatch>
```

This block prevents direct access to sensitive WordPress files.

### Static Asset Access

```apache
<FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg|eot)$">
    Order allow,deny
    Allow from all
</FilesMatch>
```

This block allows direct access to static assets like images, stylesheets, and fonts.

### Next.js Routes

```apache
RewriteRule ^recomendador-de-tarjetas-de-credito-p1-next(/.*)?$ topfinanzas-pages-mx/recomendador-de-tarjetas-de-credito-p1-next [L,QSA]
RewriteRule ^soluciones-financieras/([^/]+)-next(/.*)?$ topfinanzas-pages-mx/soluciones-financieras/$1-next [L,QSA]
```

These rules handle URLs with the "-next" suffix, routing them to the Next.js application.

- The first rule handles the recommender page
- The second rule handles any page in the "soluciones-financieras" directory with the "-next" suffix

### Next.js Static Assets

```apache
RewriteRule ^_next/(.*)$ topfinanzas-pages-mx/_next/$1 [L]
```

This rule routes requests for Next.js static assets (CSS, JavaScript, images generated by Next.js) to the proper location.

### Next.js API Routes

```apache
RewriteRule ^api/(.*)$ topfinanzas-pages-mx/api/$1 [L,QSA]
```

This rule routes API requests to the Next.js API endpoints, preserving any query string parameters.

### WordPress Default Handling

```apache
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /mx/index.php [L]
```

These rules are the standard WordPress rules that handle all other requests. If a file or directory doesn't exist, the request is routed to WordPress's index.php.

## Flag Explanations

Several flags are used in the rewrite rules:

- `[L]` - Last rule, stop processing if this rule matches
- `[QSA]` - Query String Append, preserves any query parameters in the URL
- `[R=301]` - Redirect (301 Permanent), not used in our rules but commonly seen
- `[NC]` - No Case, makes the rule case-insensitive (not used here but useful to know)

## Testing the Rules

After implementing these rules, test the following URLs to verify proper routing:

1. WordPress URLs:
   - `https://topfinanzas.com/mx/`
   - `https://topfinanzas.com/mx/recomendador-de-tarjetas-de-credito-p1`

2. Next.js URLs:
   - `https://topfinanzas.com/mx/recomendador-de-tarjetas-de-credito-p1-next`
   - `https://topfinanzas.com/mx/soluciones-financieras/guia-tarjeta-de-credito-nu-bank-next`

3. Static Assets:
   - `https://topfinanzas.com/mx/_next/static/css/[hash].css`
   - `https://topfinanzas.com/mx/_next/static/chunks/[hash].js`

## Troubleshooting

If the rules don't work as expected:

1. Check if mod_rewrite is enabled: `sudo a2enmod rewrite`
2. Verify Apache config permits .htaccess overrides:

   ```apache
   <Directory /var/www/html/mx>
       AllowOverride All
   </Directory>
   ```

3. Check Apache error logs: `tail -f /var/log/apache2/error.log`
4. Use the [RewriteLog directive](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html#rewritelog) to enable detailed logging of rewrite rule processing

## Backup and Restore

Always keep a backup of the original .htaccess file before making changes:

```bash
cp /var/www/html/mx/.htaccess /var/www/html/mx/.htaccess.bak.$(date +%Y%m%d%H%M%S)
```

To restore from backup:

```bash
cp /var/www/html/mx/.htaccess.bak.[timestamp] /var/www/html/mx/.htaccess
